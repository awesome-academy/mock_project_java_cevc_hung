<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layouts/fragments :: head(title='Edit Tour')}"></head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav th:replace="~{layouts/fragments :: sidebar(${activePage})}"></nav>
            
            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Edit Tour</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <a th:href="@{/admin/tours}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Tours
                        </a>
                    </div>
                </div>

                <!-- Flash Messages -->
                <div th:replace="~{layouts/fragments :: flash-messages}"></div>

                <!-- Edit Tour Form -->
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Tour Information</h5>
                            </div>
                            <div class="card-body">
                                <form th:action="@{/admin/tours/{id}/edit(id=${tour.id})}" th:object="${tourUpdateRequest}" method="post">
                                    <div class="row g-3">
                                        <!-- Title -->
                                        <div class="col-md-12">
                                            <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="title" th:field="*{title}" 
                                                   placeholder="Enter tour title" required>
                                            <div th:if="${#fields.hasErrors('title')}" class="text-danger">
                                                <span th:errors="*{title}"></span>
                                            </div>
                                        </div>

                                        <!-- Description -->
                                        <div class="col-md-12">
                                            <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                                            <textarea class="form-control" id="description" th:field="*{description}" 
                                                      rows="4" placeholder="Enter tour description" required></textarea>
                                            <div th:if="${#fields.hasErrors('description')}" class="text-danger">
                                                <span th:errors="*{description}"></span>
                                            </div>
                                        </div>

                                        <!-- Price -->
                                        <div class="col-md-6">
                                            <label for="price" class="form-label">Price (VND) <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="price" th:field="*{price}" 
                                                   min="0" step="1000" placeholder="Enter price" required>
                                            <div th:if="${#fields.hasErrors('price')}" class="text-danger">
                                                <span th:errors="*{price}"></span>
                                            </div>
                                        </div>

                                        <!-- Location -->
                                        <div class="col-md-6">
                                            <label for="location" class="form-label">Location <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="location" th:field="*{location}" 
                                                   placeholder="Enter location" required>
                                            <div th:if="${#fields.hasErrors('location')}" class="text-danger">
                                                <span th:errors="*{location}"></span>
                                            </div>
                                        </div>

                                        <!-- Category -->
                                        <div class="col-md-6">
                                            <label for="categoryId" class="form-label">Category</label>
                                            <select class="form-select" id="categoryId" th:field="*{categoryId}">
                                                <option value="">Select a category</option>
                                                <option th:each="category : ${categories}" 
                                                        th:value="${category.id}" 
                                                        th:selected="${category.id == tourUpdateRequest.categoryId}"
                                                        th:text="${category.name}">Category</option>
                                            </select>
                                            <div th:if="${#fields.hasErrors('categoryId')}" class="text-danger">
                                                <span th:errors="*{categoryId}"></span>
                                            </div>
                                        </div>


                                        <!-- Seats Total -->
                                        <div class="col-md-6">
                                            <label for="seatsTotal" class="form-label">Total Seats <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="seatsTotal" th:field="*{seatsTotal}" 
                                                   min="1" placeholder="Enter total seats" required>
                                            <div th:if="${#fields.hasErrors('seatsTotal')}" class="text-danger">
                                                <span th:errors="*{seatsTotal}"></span>
                                            </div>
                                        </div>

                                        <!-- Seats Available -->
                                        <div class="col-md-6">
                                            <label for="seatsAvailable" class="form-label">Available Seats</label>
                                            <input type="number" class="form-control" id="seatsAvailable" th:field="*{seatsAvailable}" 
                                                   min="0" placeholder="Enter available seats">
                                            <div th:if="${#fields.hasErrors('seatsAvailable')}" class="text-danger">
                                                <span th:errors="*{seatsAvailable}"></span>
                                            </div>
                                        </div>

                                        <!-- Start Date -->
                                        <div class="col-md-6">
                                            <label for="startDate" class="form-label">Start Date</label>
                                            <input type="datetime-local" class="form-control" id="startDate" 
                                                   th:data-value="${tourUpdateRequest.startDate}"
                                                   th:field="*{startDate}">
                                            <div th:if="${#fields.hasErrors('startDate')}" class="text-danger">
                                                <span th:errors="*{startDate}"></span>
                                            </div>
                                        </div>

                                        <!-- End Date -->
                                        <div class="col-md-6">
                                            <label for="endDate" class="form-label">End Date</label>
                                            <input type="datetime-local" class="form-control" id="endDate" 
                                                   th:data-value="${tourUpdateRequest.endDate}"
                                                   th:field="*{endDate}">
                                            <div th:if="${#fields.hasErrors('endDate')}" class="text-danger">
                                                <span th:errors="*{endDate}"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mt-4">
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save"></i> Update Tour
                                            </button>
                                            <a th:href="@{/admin/tours}" class="btn btn-secondary">
                                                <i class="fas fa-times"></i> Cancel
                                            </a>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Tour Details -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Tour Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="text-center">
                                    <img th:src="${tour.thumbnailUrl ?: 'https://via.placeholder.com/300x200?text=No+Image'}" 
                                         class="img-fluid rounded mb-3" style="max-height: 200px;">
                                    <h5 th:text="${tour.title}">Tour Title</h5>
                                    <p class="text-muted" th:text="${tour.description}">Tour description</p>
                                    
                                    <div class="row text-center mb-3">
                                        <div class="col-6">
                                            <small class="text-muted">Price</small>
                                            <div class="fw-bold text-success" th:text="${#numbers.formatDecimal(tour.price, 0, 'COMMA', 0, 'POINT')} + ' VND'">0 VND</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Location</small>
                                            <div class="fw-bold" th:text="${tour.location}">Location</div>
                                        </div>
                                    </div>

                                    <div class="row text-center mb-3">
                                        <div class="col-6">
                                            <small class="text-muted">Seats</small>
                                            <div class="fw-bold" th:text="${tour.seatsAvailable} + '/' + ${tour.seatsTotal}">0/0</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Status</small>
                                            <div>
                                                <span th:if="${tour.status.name() == 'ACTIVE'}" class="badge bg-success">Active</span>
                                                <span th:if="${tour.status.name() == 'INACTIVE'}" class="badge bg-secondary">Inactive</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row text-center">
                                        <div class="col-6">
                                            <small class="text-muted">Bookings</small>
                                            <div class="fw-bold" th:text="${tour.totalBookings}">0</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Reviews</small>
                                            <div class="fw-bold" th:text="${tour.totalReviews}">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Quick Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <form th:action="@{/admin/tours/{id}/toggle-status(id=${tour.id})}" method="post" class="d-inline">
                                        <button type="submit" class="btn btn-warning w-100">
                                            <i th:if="${tour.status.name() == 'ACTIVE'}" class="fas fa-pause"></i>
                                            <i th:if="${tour.status.name() == 'INACTIVE'}" class="fas fa-play"></i>
                                            <span th:if="${tour.status.name() == 'ACTIVE'}">Deactivate</span>
                                            <span th:if="${tour.status.name() == 'INACTIVE'}">Activate</span>
                                        </button>
                                    </form>
                                    <form th:action="@{/admin/tours/{id}/delete(id=${tour.id})}" method="post" class="d-inline"
                                          onsubmit="return confirm('Are you sure you want to delete this tour?')">
                                        <button type="submit" class="btn btn-danger w-100">
                                            <i class="fas fa-trash"></i> Delete Tour
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div th:replace="~{layouts/fragments :: scripts}"></div>
    <script>
        // Format datetime for datetime-local inputs
        document.addEventListener('DOMContentLoaded', function() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            // Format start date
            if (startDateInput && startDateInput.dataset.value) {
                const startDateValue = startDateInput.dataset.value;
                if (startDateValue && startDateValue !== 'null') {
                    // Convert from "2025-10-29T16:05:00" to "2025-10-29T16:05"
                    const formattedStartDate = startDateValue.substring(0, 16);
                    startDateInput.value = formattedStartDate;
                }
            }
            
            // Format end date
            if (endDateInput && endDateInput.dataset.value) {
                const endDateValue = endDateInput.dataset.value;
                if (endDateValue && endDateValue !== 'null') {
                    // Convert from "2025-10-29T16:05:00" to "2025-10-29T16:05"
                    const formattedEndDate = endDateValue.substring(0, 16);
                    endDateInput.value = formattedEndDate;
                }
            }
        });
    </script>
</body>
</html>
